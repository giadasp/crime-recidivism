~
#strata(gender)
# # race +
+ age_at_release
# residence_puma +
+ gang_affiliated # error: only male
# supervision_risk_score_first +
# supervision_level_first +
+ education_level
#+ dependents #p>0.4
+ prison_offense  # maybe we need to put other and violentnonsex together
+ prison_years
+ prior_arrest_episodes_felony
+ prior_arrest_episodes_misd
+ prior_arrest_episodes_violent # NS p=0.7
+ prior_arrest_episodes_property
+ prior_arrest_episodes_drug  # NS p=0.7
+ prior_arrest_episodes_ppviolationcharges
+ prior_arrest_episodes_domesticviolencecharges
+ prior_arrest_episodes_guncharges # NS p=0.8
+ prior_conviction_episodes_felony
+ prior_conviction_episodes_misd  # NS p=0.1
+ prior_conviction_episodes_violent  # NS p=0.1
+ prior_conviction_episodes_prop  # NS p=0.4
+ prior_conviction_episodes_drug  # NS p=0.4
+ prior_conviction_episodes_ppviolationcharges
+ prior_conviction_episodes_domesticviolencecharges  # NS p=0.3
#+ prior_conviction_episodes_guncharges  # NS p=0.6
+ prior_revocations_parole
+ prior_revocations_probation  # NS p=0.3
+ condition_mh_sa
+ condition_cog_ed # NS p=0.4
#+ condition_other  # NS p=0.3
+ violations_electronicmonitoring
+ violations_instruction  # NS p=0.2
#+ violations_failtoreport  # NS p=0.3
+ violations_movewithoutpermission
+ delinquency_reports
+ program_attendances
+ program_unexcusedabsences
+ residence_changes
#+ avg_days_per_drugtest #it does not have any sense
+ drugtests_thc_positive
# + drugtests_cocaine_positive  #NS p=0.2
+ drugtests_meth_positive
#+ drugtests_other_positive
#+ percent_days_employed
#+ jobs_per_year
+ employment_exempt
,
model=TRUE ,
data = training_s,
x=TRUE,
y=TRUE,
id = id,
control= coxph.control(iter.max=1000)
)
print(coxmodel %>%
gtsummary::tbl_regression(exp = TRUE))
summary(training_recoded_m_drug_tested)
sum(training_recoded$drugtests_meth_positive!="not tested")
training_recoded_m_drug_tested <- training_recoded[(training_recoded$gender=="M" && training_recoded$drugtests_meth_positive!="not tested"),]
summary(training_recoded_m_drug_tested)
training_recoded_m_drug_tested <- training_recoded[(training_recoded$gender=="M" & training_recoded$drugtests_meth_positive!="not tested"),]
summary(training_recoded_m_drug_tested)
training_recoded_m %>%
#mutate( thc_test_ints = cut(drugtests_meth_positive ,breaks =)) %>%
group_by(drugtests_meth_positive) %>%
summarize(mean(avg_days_per_drugtest))
library(GGally)
#ggpairs(training_recoded[,2:10])
N <- nrow(training_recoded_m)
#transform dataset
training_s <- transform_training_data(training_recoded_m_drug_tested)
#cox model
coxmodel <- coxph(
Surv(time=tstart, time2=tstop, event=recidive)
~
#strata(gender)
# # race +
+ age_at_release
# residence_puma +
+ gang_affiliated # error: only male
# supervision_risk_score_first +
# supervision_level_first +
+ education_level
#+ dependents #p>0.4
+ prison_offense  # maybe we need to put other and violentnonsex together
+ prison_years
+ prior_arrest_episodes_felony
+ prior_arrest_episodes_misd
+ prior_arrest_episodes_violent # NS p=0.7
+ prior_arrest_episodes_property
+ prior_arrest_episodes_drug  # NS p=0.7
+ prior_arrest_episodes_ppviolationcharges
+ prior_arrest_episodes_domesticviolencecharges
+ prior_arrest_episodes_guncharges # NS p=0.8
+ prior_conviction_episodes_felony
+ prior_conviction_episodes_misd  # NS p=0.1
+ prior_conviction_episodes_violent  # NS p=0.1
+ prior_conviction_episodes_prop  # NS p=0.4
+ prior_conviction_episodes_drug  # NS p=0.4
+ prior_conviction_episodes_ppviolationcharges
+ prior_conviction_episodes_domesticviolencecharges  # NS p=0.3
#+ prior_conviction_episodes_guncharges  # NS p=0.6
+ prior_revocations_parole
+ prior_revocations_probation  # NS p=0.3
+ condition_mh_sa
+ condition_cog_ed # NS p=0.4
#+ condition_other  # NS p=0.3
+ violations_electronicmonitoring
+ violations_instruction  # NS p=0.2
#+ violations_failtoreport  # NS p=0.3
+ violations_movewithoutpermission
+ delinquency_reports
+ program_attendances
+ program_unexcusedabsences
+ residence_changes
#+ avg_days_per_drugtest #it does not have any sense
+ drugtests_thc_positive
# + drugtests_cocaine_positive  #NS p=0.2
+ drugtests_meth_positive
#+ drugtests_other_positive
#+ percent_days_employed
#+ jobs_per_year
+ employment_exempt
,
model=TRUE ,
data = training_s,
x=TRUE,
y=TRUE,
id = id,
control= coxph.control(iter.max=1000)
)
print(coxmodel %>%
gtsummary::tbl_regression(exp = TRUE))
droplevels(training_recoded_m_drug_tested)
summary(training_recoded_m_drug_tested)
droplevels(training_recoded_m_drug_tested$drugtests_meth_positive)
summary(training_recoded_m_drug_tested)
training_recoded_m_drug_tested <- training_recoded_m_drug_tested(subdf, function(x) if(is.factor(x)) factor(x) else x)
View(training_recoded_m_drug_tested)
training_recoded_m_drug_tested <- lapply(training_recoded_m_drug_tested, function(x) if(is.factor(x)) factor(x) else x)
summary(training_recoded_m_drug_tested)
training_recoded_m_drug_tested <- apply(training_recoded_m_drug_tested,1, function(x) if(is.factor(x)) factor(x) else x)
training_recoded_m_drug_tested <- training_recoded[(training_recoded$gender=="M" & training_recoded$drugtests_meth_positive!="not tested"),]
training_recoded_m_drug_tested <- apply(training_recoded_m_drug_tested,1, function(x) if(is.factor(x)) factor(x) else x)
summary(training_recoded_m_drug_tested)
training_recoded_m_drug_tested <- training_recoded[(training_recoded$gender=="M" & training_recoded$drugtests_meth_positive!="not tested"),]
training_recoded_m_drug_tested <- apply(training_recoded_m_drug_tested,2, function(x) if(is.factor(x)) factor(x) else x)
summary(training_recoded_m_drug_tested)
training_recoded_m_drug_tested <- training_recoded %>%
filter(gender == "M") %>%
filter(drugtests_meth_positive != "not tested") %>%
droplevels()
summary(training_recoded_m_drug_tested)
#ggpairs(training_recoded[,2:10])
N <- nrow(training_recoded_m)
#transform dataset
training_s <- transform_training_data(training_recoded_m_drug_tested)
#cox model
coxmodel <- coxph(
Surv(time=tstart, time2=tstop, event=recidive)
~
#strata(gender)
# # race +
+ age_at_release
# residence_puma +
+ gang_affiliated # error: only male
# supervision_risk_score_first +
# supervision_level_first +
+ education_level
#+ dependents #p>0.4
+ prison_offense  # maybe we need to put other and violentnonsex together
+ prison_years
+ prior_arrest_episodes_felony
+ prior_arrest_episodes_misd
+ prior_arrest_episodes_violent # NS p=0.7
+ prior_arrest_episodes_property
+ prior_arrest_episodes_drug  # NS p=0.7
+ prior_arrest_episodes_ppviolationcharges
+ prior_arrest_episodes_domesticviolencecharges
+ prior_arrest_episodes_guncharges # NS p=0.8
+ prior_conviction_episodes_felony
+ prior_conviction_episodes_misd  # NS p=0.1
+ prior_conviction_episodes_violent  # NS p=0.1
+ prior_conviction_episodes_prop  # NS p=0.4
+ prior_conviction_episodes_drug  # NS p=0.4
+ prior_conviction_episodes_ppviolationcharges
+ prior_conviction_episodes_domesticviolencecharges  # NS p=0.3
#+ prior_conviction_episodes_guncharges  # NS p=0.6
+ prior_revocations_parole
+ prior_revocations_probation  # NS p=0.3
+ condition_mh_sa
+ condition_cog_ed # NS p=0.4
#+ condition_other  # NS p=0.3
+ violations_electronicmonitoring
+ violations_instruction  # NS p=0.2
#+ violations_failtoreport  # NS p=0.3
+ violations_movewithoutpermission
+ delinquency_reports
+ program_attendances
+ program_unexcusedabsences
+ residence_changes
#+ avg_days_per_drugtest #it does not have any sense
+ drugtests_thc_positive
# + drugtests_cocaine_positive  #NS p=0.2
+ drugtests_meth_positive
#+ drugtests_other_positive
#+ percent_days_employed
#+ jobs_per_year
+ employment_exempt
,
model=TRUE ,
data = training_s,
x=TRUE,
y=TRUE,
id = id,
control= coxph.control(iter.max=1000)
)
print(coxmodel %>%
gtsummary::tbl_regression(exp = TRUE))
test_1_recoded_m_drug_tested <- test_1_recoded %>%
filter(gender == "M") %>%
filter(drugtests_meth_positive != "not tested") %>%
droplevels()
test_1_recoded_m_drug_tested <- test_1_recoded %>%
filter(gender == "M") %>%
filter(drugtests_meth_positive != "not tested") %>%
droplevels()
test_1_s <- transform_test_data(test_1_recoded_m)
N <- nrow(test_1_recoded_m)
# survival probability
predictions_1 <- 1-predictSurvProb(coxmodel,
newdata = test_1_s[seq(1,nrow(test_1_s),4),],
times = c(time_span*2, time_span*3, time_span*4)
)
# number of events for each time
predictions_2 <- t(
matrix(
predict(
coxmodel,
newdata=test_1_s,
id=id,
type="expected"),
ncol=N)
)
test_1_recoded <- clean_test_data(test_1)
test_1_recoded <- arrange(test_1_recoded, id)
test_1_recoded_m_drug_tested <- test_1_recoded %>%
filter(gender == "M") %>%
filter(drugtests_meth_positive != "not tested") %>%
droplevels()
test_1_s <- transform_test_data(test_1_recoded_m_drug_tested)
N <- nrow(test_1_recoded_m)
# survival probability
predictions_1 <- 1-predictSurvProb(coxmodel,
newdata = test_1_s[seq(1,nrow(test_1_s),4),],
times = c(time_span*2, time_span*3, time_span*4)
)
# number of events for each time
predictions_2 <- t(
matrix(
predict(
coxmodel,
newdata=test_1_s,
id=id,
type="expected"),
ncol=N)
)
predictions_3_surv <- round(exp(-predictions_2),2)[,2:4]
cbind(round(predictions_1,2), round(predictions_2[,2:4],2), predictions_3_surv, test_1_recoded_m[,c("recidivism_arrest_year1","recidivism_arrest_year2","recidivism_arrest_year3")])
N <- nrow(test_1_recoded_m_drug_tested)
# survival probability
predictions_1 <- 1-predictSurvProb(coxmodel,
newdata = test_1_s[seq(1,nrow(test_1_s),4),],
times = c(time_span*2, time_span*3, time_span*4)
)
# number of events for each time
predictions_2 <- t(
matrix(
predict(
coxmodel,
newdata=test_1_s,
id=id,
type="expected"),
ncol=N)
)
predictions_3_surv <- round(exp(-predictions_2),2)[,2:4]
cbind(round(predictions_1,2), round(predictions_2[,2:4],2), predictions_3_surv, test_1_recoded_m[,c("recidivism_arrest_year1","recidivism_arrest_year2","recidivism_arrest_year3")])
cbind(round(predictions_1,2), round(predictions_2[,2:4],2), predictions_3_surv, test_1_recoded_m_drug_tested[,c("recidivism_arrest_year1","recidivism_arrest_year2","recidivism_arrest_year3")])
cbind(round(predictions_1,2), round(predictions_2[,2:4],2), predictions_3_surv, test_1_recoded_m_drug_tested[,c("recidivism_arrest_year1","recidivism_arrest_year2","recidivism_arrest_year3")])
cbind(predictions_expected_events,test_1_recoded_m_drug_tested[,c("recidivism_arrest_year1","recidivism_arrest_year2","recidivism_arrest_year3")]))
cbind(predictions_expected_events,test_1_recoded_m_drug_tested[,c("recidivism_arrest_year1","recidivism_arrest_year2","recidivism_arrest_year3")])
# number of events for each time
predictions_expected_events <- round(t(
matrix(
predict(
coxmodel,
newdata=test_1_s,
id=id,
type="expected"),
ncol=N)[2:4,]),2)
cbind(predictions_expected_events,test_1_recoded_m_drug_tested[,c("recidivism_arrest_year1","recidivism_arrest_year2","recidivism_arrest_year3")])
predictions_risky[predictions_risky>threshold] <- 1
predictions_risky <- predictions_expected_events
predictions_risky[predictions_risky>threshold] <- 1
threshold = 0.75
predictions_risky <- predictions_expected_events
predictions_risky[predictions_risky>threshold] <- 1
cbind(predictions_risky,test_1_recoded_m_drug_tested[,c("recidivism_arrest_year1","recidivism_arrest_year2","recidivism_arrest_year3")])
predictions_risky[predictions_risky<=threshold] <- 0
cbind(predictions_risky,test_1_recoded_m_drug_tested[,c("recidivism_arrest_year1","recidivism_arrest_year2","recidivism_arrest_year3")])
predictions_risk <-round(t(
matrix(
predict(
coxmodel,
newdata=test_1_s,
id=id,
type="risk"),
ncol=N)[2:4,]),2)
cbind(predictions_risk,test_1_recoded_m_drug_tested[,c("recidivism_arrest_year1","recidivism_arrest_year2","recidivism_arrest_year3")])
cz <- cox.zph(coxmodel)
print(cz)
plot(cz)
plot(cz)
plot(cz, lwd=1)
plot(cz, lwd=2)
plot(cz[2], lwd=2)
plot(cz[1], lwd=1)
cz[1]
cz[2]
plot(cz[1])
plot(cz[3])
plot(cz[4])
cz[4]
cz[5]
cz[6]
cz[7]
cz[8]
cz[9]
plot(cz[9])
# + prison_offense  # maybe we need to put other and violentnonsex together
# + prison_years
# + prior_arrest_episodes_felony
# + prior_arrest_episodes_misd
# + prior_arrest_episodes_violent # NS p=0.7
# + prior_arrest_episodes_property
# + prior_arrest_episodes_drug  # NS p=0.7
# + prior_arrest_episodes_ppviolationcharges
# + prior_arrest_episodes_domesticviolencecharges
# + prior_arrest_episodes_guncharges # NS p=0.8
# + prior_conviction_episodes_felony
# + prior_conviction_episodes_misd  # NS p=0.1
# + prior_conviction_episodes_violent  # NS p=0.1
# + prior_conviction_episodes_prop  # NS p=0.4
# + prior_conviction_episodes_drug  # NS p=0.4
# + prior_conviction_episodes_ppviolationcharges
# + prior_conviction_episodes_domesticviolencecharges  # NS p=0.3
# #+ prior_conviction_episodes_guncharges  # NS p=0.6
# + prior_revocations_parole
# + prior_revocations_probation  # NS p=0.3
# + condition_mh_sa
# + condition_cog_ed # NS p=0.4
# #+ condition_other  # NS p=0.3
# + violations_electronicmonitoring
# + violations_instruction  # NS p=0.2
# #+ violations_failtoreport  # NS p=0.3
# + violations_movewithoutpermission
# + delinquency_reports
# + program_attendances
# + program_unexcusedabsences
# + residence_changes
# #+ avg_days_per_drugtest #it does not have any sense
# + drugtests_thc_positive
# # + drugtests_cocaine_positive  #NS p=0.2
# + drugtests_meth_positive
# #+ drugtests_other_positive
# #+ percent_days_employed
# #+ jobs_per_year
#cox model
coxmodel <- coxph(
Surv(time=tstart, time2=tstop, event=recidive)
~
#strata(gender)
# # race +
+ age_at_release
# residence_puma +
+ gang_affiliated # error: only male
# supervision_risk_score_first +
# supervision_level_first +
+ education_level
#+ dependents #p>0.4
# + prison_offense  # maybe we need to put other and violentnonsex together
# + prison_years
# + prior_arrest_episodes_felony
# + prior_arrest_episodes_misd
# + prior_arrest_episodes_violent # NS p=0.7
# + prior_arrest_episodes_property
# + prior_arrest_episodes_drug  # NS p=0.7
# + prior_arrest_episodes_ppviolationcharges
# + prior_arrest_episodes_domesticviolencecharges
# + prior_arrest_episodes_guncharges # NS p=0.8
# + prior_conviction_episodes_felony
# + prior_conviction_episodes_misd  # NS p=0.1
# + prior_conviction_episodes_violent  # NS p=0.1
# + prior_conviction_episodes_prop  # NS p=0.4
# + prior_conviction_episodes_drug  # NS p=0.4
# + prior_conviction_episodes_ppviolationcharges
# + prior_conviction_episodes_domesticviolencecharges  # NS p=0.3
# #+ prior_conviction_episodes_guncharges  # NS p=0.6
# + prior_revocations_parole
# + prior_revocations_probation  # NS p=0.3
# + condition_mh_sa
# + condition_cog_ed # NS p=0.4
# #+ condition_other  # NS p=0.3
# + violations_electronicmonitoring
# + violations_instruction  # NS p=0.2
# #+ violations_failtoreport  # NS p=0.3
# + violations_movewithoutpermission
# + delinquency_reports
# + program_attendances
# + program_unexcusedabsences
# + residence_changes
# #+ avg_days_per_drugtest #it does not have any sense
# + drugtests_thc_positive
# # + drugtests_cocaine_positive  #NS p=0.2
# + drugtests_meth_positive
# #+ drugtests_other_positive
# #+ percent_days_employed
# #+ jobs_per_year
+ employment_exempt
,
model=TRUE ,
data = training_s,
x=TRUE,
y=TRUE,
id = id,
control= coxph.control(iter.max=1000)
)
cz <- cox.zph(coxmodel)
print(cz)
plot(cz[1], lwd=1)
#cox model
coxmodel <- coxph(
Surv(time=tstart, time2=tstop, event=recidive)
~
#strata(gender)
# # race +
+ age_at_release
# residence_puma +
+ gang_affiliated # error: only male
# supervision_risk_score_first +
# supervision_level_first +
+ education_level
#+ dependents #p>0.4
+ prison_offense  # maybe we need to put other and violentnonsex together
# + prison_years
# + prior_arrest_episodes_felony
# + prior_arrest_episodes_misd
# + prior_arrest_episodes_violent # NS p=0.7
# + prior_arrest_episodes_property
# + prior_arrest_episodes_drug  # NS p=0.7
# + prior_arrest_episodes_ppviolationcharges
# + prior_arrest_episodes_domesticviolencecharges
# + prior_arrest_episodes_guncharges # NS p=0.8
# + prior_conviction_episodes_felony
# + prior_conviction_episodes_misd  # NS p=0.1
# + prior_conviction_episodes_violent  # NS p=0.1
# + prior_conviction_episodes_prop  # NS p=0.4
# + prior_conviction_episodes_drug  # NS p=0.4
# + prior_conviction_episodes_ppviolationcharges
# + prior_conviction_episodes_domesticviolencecharges  # NS p=0.3
# #+ prior_conviction_episodes_guncharges  # NS p=0.6
# + prior_revocations_parole
# + prior_revocations_probation  # NS p=0.3
# + condition_mh_sa
# + condition_cog_ed # NS p=0.4
# #+ condition_other  # NS p=0.3
# + violations_electronicmonitoring
# + violations_instruction  # NS p=0.2
# #+ violations_failtoreport  # NS p=0.3
# + violations_movewithoutpermission
# + delinquency_reports
# + program_attendances
# + program_unexcusedabsences
# + residence_changes
# #+ avg_days_per_drugtest #it does not have any sense
# + drugtests_thc_positive
# # + drugtests_cocaine_positive  #NS p=0.2
# + drugtests_meth_positive
# #+ drugtests_other_positive
# #+ percent_days_employed
# #+ jobs_per_year
+ employment_exempt
,
model=TRUE ,
data = training_s,
x=TRUE,
y=TRUE,
id = id,
control= coxph.control(iter.max=1000)
)
print(coxmodel %>%
gtsummary::tbl_regression(exp = TRUE))
survminer::ggforest(coxmodel, data = training_s)
cz <- cox.zph(coxmodel)
print(cz)
plot(cz[1], lwd=1)
plot(cz[3], lwd=2)
plot(cz[2], lwd=2)
predictCox(coxmodel)
